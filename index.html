<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com"></script>
  <style>
    :root { --p-color: #6366f1; --bg: #1a1a1a; --card: #262626; --text: #eee; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; width: 100%; height: 100%; overflow-x: hidden; border-radius: 8px; }
    
    /* –û–∫–Ω–æ –∏ –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    #window-header { background: #312e81; height: 32px; display: flex; justify-content: space-between; align-items: center; cursor: grab; position: sticky; top: 0; z-index: 10001; }
    .window-controls button { background: transparent; border: none; color: white; width: 30px; height: 32px; cursor: pointer; }
    .window-controls button:hover { background: rgba(255,255,255,0.1); }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .tabs { display: flex; background: #222; border-bottom: 1px solid #444; }
    .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #888; cursor: pointer; font-size: 11px; font-weight: bold; }
    .tab-btn.active { color: white; border-bottom: 2px solid var(--p-color); background: #2a2a2a; }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç */
    .content { padding: 15px; }
    .hidden { display: none; }
    input, select, textarea { background: #333; color: white; border: 1px solid #444; border-radius: 4px; padding: 4px; }
    
    /* –ü–æ—Ä—Ç—Ä–µ—Ç */
    .portrait-frame { width: 100px; height: 100px; margin: 0 auto 15px; border: 3px solid var(--p-color); border-radius: 10px; overflow: hidden; cursor: pointer; position: relative; background: #222; }
    .portrait-frame img { width: 100%; height: 100%; object-fit: cover; }
    .portrait-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; font-size: 10px; }
    .portrait-frame:hover .portrait-overlay { opacity: 1; }

    /* HP –∏ AC */
    .stats-row { display: flex; justify-content: space-between; align-items: center; background: #2d0a0a; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
    #shield-icon { fill: #4338ca; transition: 0.3s; }
    .shield-damaged { fill: #991b1b !important; filter: drop-shadow(0 0 5px #ef4444); }

    /* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */
    .stat-card { background: var(--card); border: 1px solid #333; border-radius: 6px; padding: 8px; margin-bottom: 6px; cursor: pointer; transition: 0.2s; }
    .stat-card:hover { background: #333; }
    .skill-row { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 0; border-top: 1px solid #333; margin-top: 4px; }

    /* –ö—É–±–∏–∫ –∏ –í–∏–∑—É–∞–ª */
    #dice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .die-animation { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border-radius: 8px; animation: rollDie 0.6s ease-out forwards; }
    @keyframes rollDie { 0% { transform: scale(0) rotate(0deg); opacity: 0; } 100% { transform: scale(1) rotate(720deg); opacity: 1; } }
    #blood-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000; transition: 0.5s; }
    
    /* –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è –∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
    .slot-orb { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #4338ca; background: #1e1b4b; cursor: pointer; }
    .slot-orb.active { background: radial-gradient(circle at 30% 30%, #a78bfa, #4338ca); box-shadow: 0 0 10px #6366f1; }
    .inv-item { background: #222; border: 1px solid #444; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 12px; }

    /* –¢–µ–∫—Å—Ç—É—Ä—ã */
    .die-stone { background: #777; filter: contrast(1.2); }
    .die-wood { background: #5d4037; border: 2px solid #3e2723; }
  </style>
</head>
<body>

<div id="window-header">
  <span style="font-size: 11px; margin-left: 10px;">D&D INTERACTIVE SHEET</span>
  <div class="window-controls">
    <button onclick="OBR.action.setHeight(32)">‚Äî</button>
    <button onclick="OBR.action.setHeight(600); OBR.action.setWidth(350)">üóñ</button>
  </div>
</div>

<div id="blood-overlay"></div>
<div id="dice-overlay"></div>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab('stats', this)">–°–¢–ê–¢–´</button>
  <button class="tab-btn" onclick="showTab('weapons', this)">–ë–û–ô</button>
  <button class="tab-btn" onclick="showTab('spells', this)">–ú–ê–ì–ò–Ø</button>
  <button class="tab-btn" onclick="showTab('inv', this)">–°–£–ú–ö–ê</button>
</div>

<div class="content">
  <!-- –í–ö–õ–ê–î–ö–ê –°–¢–ê–¢–´ -->
  <div id="tab-stats">
    <div class="portrait-frame" onclick="document.getElementById('p-input').classList.toggle('hidden')">
      <img id="charPortrait" src="https://www.svgrepo.com">
      <div class="portrait-overlay">–ò–ó–ú–ï–ù–ò–¢–¨</div>
    </div>
    <input type="text" id="p-input" class="hidden" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ..." style="width:90%; margin-bottom:10px;" oninput="updatePortrait(this.value)">
    
    <input type="text" id="charName" placeholder="–ò–º—è –≥–µ—Ä–æ—è" style="width: 93%; font-weight: bold; margin-bottom: 10px;">

    <div class="stats-row">
      <div>
        <div style="font-size:10px; color:#888;">HP</div>
        <input type="number" id="currentHp" style="width:40px; font-size:16px;"> / <input type="number" id="maxHp" style="width:40px;">
      </div>
      <div style="position:relative; display:flex; align-items:center; justify-content:center;">
        <svg id="shield-icon" viewBox="0 0 24 24" width="45" height="45"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
        <input type="number" id="charAC" value="10" style="position:absolute; width:20px; background:transparent; border:none; font-weight:bold; color:white; text-align:center;">
      </div>
      <button onclick="rollInitiative()" style="background:#f59e0b; border:none; padding:10px; border-radius:4px; font-weight:bold; cursor:pointer;">INIT</button>
    </div>

    <div style="display:flex; gap:5px; margin-bottom:10px;">
      <button id="btn-adv" class="tab-btn" style="border:1px solid #444" onclick="setAdvMode('adv')">ADV</button>
      <button id="btn-dis" class="tab-btn" style="border:1px solid #444" onclick="setAdvMode('dis')">DIS</button>
    </div>

    <div id="main-stats"></div>
  </div>

  <!-- –í–ö–õ–ê–î–ö–ê –ë–û–ô -->
  <div id="tab-weapons" class="hidden">
    <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px;">
      <label style="font-size:9px;">–¶–í–ï–¢ –ò –¢–ï–ö–°–¢–£–†–ê –ö–£–ë–û–í:</label>
      <input type="color" id="dieColor" value="#4f46e5" style="width:100%; height:20px;">
      <select id="dieTexture" style="width:100%; margin-top:5px;">
        <option value="none">–ü–ª–∞—Å—Ç–∏–∫</option>
        <option value="stone">–ö–∞–º–µ–Ω—å</option>
        <option value="wood">–î–µ—Ä–µ–≤–æ</option>
      </select>
    </div>
    <button onclick="addWeapon()" style="width:100%; background:#166534; color:white; padding:8px; border:none; border-radius:4px;">+ –û–†–£–ñ–ò–ï</button>
    <div id="weapon-list" style="margin-top:10px;"></div>
  </div>

  <!-- –í–ö–õ–ê–î–ö–ê –ú–ê–ì–ò–Ø -->
  <div id="tab-spells" class="hidden">
    <div id="spell-slots-container"></div>
    <div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
      <input type="text" id="spellImport" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è..." style="width:70%;">
      <button onclick="importSpell()" style="background:var(--p-color); border:none; padding:5px; color:white;">OK</button>
      <div id="spell-list"></div>
    </div>
  </div>

  <!-- –í–ö–õ–ê–î–ö–ê –ò–ù–í–ï–ù–¢–ê–†–¨ -->
  <div id="tab-inv" class="hidden">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span>–í–µ—Å: <b id="totalWeight">0</b></span>
        <button onclick="addItem()" style="background:#166534; border:none; color:white; padding:2px 10px;">+</button>
    </div>
    <div id="inventory-list"></div>
    <div id="wallet" style="margin-top:20px; background:#222; padding:10px; border-radius:5px;">
        <div style="color:#fbbf24">GP: <input type="number" id="coin-gp" value="0" style="width:50px;"></div>
        <div style="color:#9ca3af; margin-top:5px;">SP: <input type="number" id="coin-sp" value="0" style="width:50px;"></div>
    </div>
  </div>

  <!-- –≠–ö–°–ü–û–†–¢ -->
  <div style="margin-top:30px; display:flex; gap:5px;">
    <button onclick="exportCharacter()" style="flex:1; font-size:9px; background:#333; color:#aaa; border:none; padding:5px;">–ë–≠–ö–ê–ü</button>
    <button onclick="document.getElementById('f-imp').click()" style="flex:1; font-size:9px; background:#333; color:#aaa; border:none; padding:5px;">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
    <input type="file" id="f-imp" class="hidden" onchange="importCharacter(event)">
  </div>
</div>

<script>
const OBR = window.OBR;
let advMode = 'normal';
const statsData = [
  { name: "–°–ò–õ", skills: ["–ê—Ç–ª–µ—Ç–∏–∫–∞"] },
  { name: "–õ–û–í", skills: ["–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞", "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å"] },
  { name: "–¢–ï–õ", skills: [] },
  { name: "–ò–ù–¢", skills: ["–ú–∞–≥–∏—è", "–ò—Å—Ç–æ—Ä–∏—è"] },
  { name: "–ú–£–î", skills: ["–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ú–µ–¥–∏—Ü–∏–Ω–∞"] },
  { name: "–•–ê–†", skills: ["–û–±–º–∞–Ω", "–£–±–µ–∂–¥–µ–Ω–∏–µ"] }
];

async function init() {
  await OBR.onReady();
  renderStats();
  renderSpellSlots();
  loadAll();
  setupSmartInputs();
  setupDoubleSidedSync();
}

function showTab(tab, btn) {
  document.querySelectorAll('.content > div').forEach(d => d.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function renderStats() {
  const container = document.getElementById('main-stats');
  statsData.forEach(s => {
    let h = `<div class="stat-card">
      <div class="stat-header" onclick="roll('${s.name}', '–ü—Ä–æ–≤–µ—Ä–∫–∞')">
        <span style="color:#fbbf24">${s.name}</span>
        <input type="number" id="mod-${s.name}" value="0" style="width:35px;" onclick="event.stopPropagation()" oninput="saveAll()">
      </div>
      <div class="skill-row" onclick="roll('${s.name}', '–°–ø–∞—Å–±—Ä–æ—Å–æ–∫')" style="color:#6366f1">üõ°Ô∏è –°–ø–∞—Å–±—Ä–æ—Å–æ–∫</div>`;
    s.skills.forEach(sk => {
      h += `<div class="skill-row" onclick="roll('${s.name}', '${sk}')">${sk}</div>`;
    });
    container.innerHTML += h + `</div>`;
  });
}

async function roll(statKey, label) {
  const mod = parseInt(document.getElementById('mod-' + statKey).value) || 0;
  const r1 = Math.floor(Math.random() * 20) + 1;
  const r2 = Math.floor(Math.random() * 20) + 1;
  
  let d20 = r1;
  let txt = `[${r1}]`;
  if(advMode === 'adv') { d20 = Math.max(r1, r2); txt = `ADV [${r1},${r2}] -> ${d20}`; }
  if(advMode === 'dis') { d20 = Math.min(r1, r2); txt = `DIS [${r1},${r2}] -> ${d20}`; }

  showDice(d20);
  const name = document.getElementById('charName').value || "–ì–µ—Ä–æ–π";
  OBR.notification.show(`${name}: ${label}\nüé≤ ${txt} + ${mod} = ${d20 + mod}`);
  setAdvMode('normal');
}

function showDice(val) {
  const ov = document.getElementById('dice-overlay');
  const tex = document.getElementById('dieTexture').value;
  ov.innerHTML = `<div class="die-animation die-${tex}" style="background:${document.getElementById('dieColor').value}">${val}</div>`;
  if(val === 20) triggerEffect('crit');
  if(val === 1) triggerEffect('fumble');
  setTimeout(() => ov.innerHTML = '', 1200);
}

function triggerEffect(type) {
  const b = document.getElementById('blood-overlay');
  if(type === 'crit') b.style.boxShadow = 'inset 0 0 100px #22c55e';
  if(type === 'fumble') b.style.boxShadow = 'inset 0 0 100px #ef4444';
  if(type === 'dmg') { document.body.style.animation = 'shake 0.3s'; setTimeout(()=>document.body.style.animation='', 300); }
  setTimeout(() => b.style.boxShadow = 'none', 600);
}

function setAdvMode(m) {
  advMode = (advMode === m) ? 'normal' : m;
  document.getElementById('btn-adv').style.background = advMode === 'adv' ? '#166534' : '';
  document.getElementById('btn-dis').style.background = advMode === 'dis' ? '#991b1b' : '';
}

function updateBloodEffect() {
    const cur = parseInt(document.getElementById('currentHp').value) || 0;
    const max = parseInt(document.getElementById('maxHp').value) || 1;
    const ov = document.getElementById('blood-overlay');
    const ratio = cur / max;
    if(ratio <= 0.5) ov.style.boxShadow = `inset 0 0 ${100 - ratio*200}px rgba(220,38,38,${0.6 - ratio})`;
    else ov.style.boxShadow = 'none';
}

function setupSmartInputs() {
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const v = input.value;
        const old = parseFloat(input.dataset.old || input.value) || 0;
        if (v.startsWith('+')) input.value = old + parseFloat(v.substring(1));
        if (v.startsWith('-')) input.value = old - parseFloat(v.substring(1));
        input.dataset.old = input.value;
        saveAll();
        syncToken();
      }
    });
    input.addEventListener('focus', () => input.dataset.old = input.value);
  });
}

async function syncToken() {
    const cur = parseInt(document.getElementById('currentHp').value);
    const max = parseInt(document.getElementById('maxHp').value);
    const ac = document.getElementById('charAC').value;
    const name = document.getElementById('charName').value;
    const items = await OBR.scene.items.getItems();
    const mine = items.find(i => i.name.includes(name));
    if(mine) {
        OBR.scene.items.updateItems([mine.id], (is) => {
            for(let i of is) {
                i.hp = { value: cur, max: max };
                i.text.content = `AC: ${ac}`;
                i.text.visible = true;
            }
        });
    }
}

function saveAll() {
    const data = {
        name: document.getElementById('charName').value,
        hp: document.getElementById('currentHp').value,
        max: document.getElementById('maxHp').value,
        ac: document.getElementById('charAC').value,
        color: document.getElementById('dieColor').value,
        tex: document.getElementById('dieTexture').value,
        port: document.getElementById('charPortrait').src
    };
    localStorage.setItem('dnd_main', JSON.stringify(data));
    updateBloodEffect();
}

function loadAll() {
    const d = JSON.parse(localStorage.getItem('dnd_main') || '{}');
    if(d.name) document.getElementById('charName').value = d.name;
    document.getElementById('currentHp').value = d.hp || 10;
    document.getElementById('maxHp').value = d.max || 10;
    document.getElementById('charAC').value = d.ac || 10;
    document.getElementById('dieColor').value = d.color || '#4f46e5';
    document.getElementById('charPortrait').src = d.port || 'https://www.svgrepo.com';
    updateBloodEffect();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ—Å—Ç–∞–ª—å–Ω—ã–µ)
function renderSpellSlots() { /* –ö–æ–¥ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞ */ }
function exportCharacter() { /* –ö–æ–¥ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞ */ }

init();
</script>
</body>
</html>
